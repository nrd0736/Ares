# ============================================================================
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ğ´Ğ»Ñ APEC
# ============================================================================
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: .\generate-ssl-cert.ps1
#
# Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: OpenSSL Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
# Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ: https://slproweb.com/products/Win32OpenSSL.html
# ============================================================================

Write-Host "ğŸ” Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ğ´Ğ»Ñ APEC" -ForegroundColor Cyan
Write-Host ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ OpenSSL
try {
    $openssl = Get-Command openssl -ErrorAction Stop
    Write-Host "âœ… OpenSSL Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: $($openssl.Source)" -ForegroundColor Green
} catch {
    Write-Host "âŒ OpenSSL Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!" -ForegroundColor Red
    Write-Host ""
    Write-Host "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ OpenSSL:" -ForegroundColor Yellow
    Write-Host "1. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ: https://slproweb.com/products/Win32OpenSSL.html" -ForegroundColor Yellow
    Write-Host "2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ²ĞµÑ€ÑĞ¸Ñ 'Win64 OpenSSL v3.x.x Light'" -ForegroundColor Yellow
    Write-Host "3. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² PATH: C:\Program Files\OpenSSL-Win64\bin" -ForegroundColor Yellow
    Write-Host ""
    exit 1
}

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
Write-Host ""
Write-Host "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ ssl/..." -ForegroundColor Cyan
New-Item -ItemType Directory -Force -Path "ssl" | Out-Null

# Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
Write-Host ""
Write-Host "ğŸ“ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ğ´Ğ»Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ):" -ForegroundColor Cyan
Write-Host ""

$country = Read-Host "Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ° (C) [RU]"
if ([string]::IsNullOrWhiteSpace($country)) { $country = "RU" }

$state = Read-Host "Ğ ĞµĞ³Ğ¸Ğ¾Ğ½ (ST) [Moscow]"
if ([string]::IsNullOrWhiteSpace($state)) { $state = "Moscow" }

$locality = Read-Host "Ğ“Ğ¾Ñ€Ğ¾Ğ´ (L) [Moscow]"
if ([string]::IsNullOrWhiteSpace($locality)) { $locality = "Moscow" }

$organization = Read-Host "ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (O) [APEC]"
if ([string]::IsNullOrWhiteSpace($organization)) { $organization = "APEC" }

$organizationalUnit = Read-Host "ĞŸĞ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ (OU) [Development]"
if ([string]::IsNullOrWhiteSpace($organizationalUnit)) { $organizationalUnit = "Development" }

$commonName = Read-Host "Ğ”Ğ¾Ğ¼ĞµĞ½ (CN) [localhost]"
if ([string]::IsNullOrWhiteSpace($commonName)) { $commonName = "localhost" }

$days = Read-Host "Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ² Ğ´Ğ½ÑÑ… [365]"
if ([string]::IsNullOrWhiteSpace($days)) { $days = "365" }

# Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ subject string
$subject = "/C=$country/ST=$state/L=$locality/O=$organization/OU=$organizationalUnit/CN=$commonName"

Write-Host ""
Write-Host "ğŸ”‘ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°..." -ForegroundColor Cyan
& openssl genrsa -out ssl/private.key 2048 2>&1 | Out-Null

if ($LASTEXITCODE -eq 0) {
    Write-Host "âœ… ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: ssl/private.key" -ForegroundColor Green
} else {
    Write-Host "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "ğŸ“„ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°..." -ForegroundColor Cyan
& openssl req -new -x509 -key ssl/private.key -out ssl/certificate.crt -days $days -subj $subject 2>&1 | Out-Null

if ($LASTEXITCODE -eq 0) {
    Write-Host "âœ… Ğ¡ĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: ssl/certificate.crt" -ForegroundColor Green
} else {
    Write-Host "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°" -ForegroundColor Red
    exit 1
}

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ğ¼Ğ¸ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸ (SAN)
Write-Host ""
Write-Host "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ (SAN)..." -ForegroundColor Cyan

$opensslConfig = @"
[req]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = v3_req

[dn]
C=$country
ST=$state
L=$locality
O=$organization
OU=$organizationalUnit
CN=$commonName

[v3_req]
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = *.localhost
DNS.3 = 127.0.0.1
IP.1 = 127.0.0.1
IP.2 = ::1
"@

$opensslConfig | Out-File -FilePath "ssl/openssl.cnf" -Encoding ASCII

Write-Host ""
Write-Host "ğŸ”‘ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ñ SAN..." -ForegroundColor Cyan
& openssl req -new -x509 -newkey rsa:2048 -sha256 -nodes `
    -keyout ssl/private.key `
    -out ssl/certificate.crt `
    -days $days `
    -config ssl/openssl.cnf 2>&1 | Out-Null

if ($LASTEXITCODE -eq 0) {
    Write-Host "âœ… Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½" -ForegroundColor Green
} else {
    Write-Host "âš ï¸  ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°" -ForegroundColor Yellow
}

# Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğµ
Write-Host ""
Write-Host "ğŸ“‹ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğµ:" -ForegroundColor Cyan
Write-Host ""
& openssl x509 -in ssl/certificate.crt -noout -text | Select-String -Pattern "Subject:|Not Before|Not After|DNS:"

# Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
Write-Host ""
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
Write-Host "âœ… SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹!" -ForegroundColor Green
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
Write-Host ""
Write-Host "ğŸ“„ Ğ¡ĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚:      ssl/certificate.crt" -ForegroundColor Cyan
Write-Host "ğŸ”‘ ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡:  ssl/private.key" -ForegroundColor Cyan
Write-Host "âš™ï¸  ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:   ssl/openssl.cnf" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸ“ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:" -ForegroundColor Yellow
Write-Host ""
Write-Host "1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» .env" -ForegroundColor White
Write-Host "2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:" -ForegroundColor White
Write-Host ""
Write-Host "   HTTPS_ENABLED=true" -ForegroundColor Gray
Write-Host "   SSL_CERT_PATH=./ssl/certificate.crt" -ForegroundColor Gray
Write-Host "   SSL_KEY_PATH=./ssl/private.key" -ForegroundColor Gray
Write-Host "   CORS_ORIGIN=https://localhost:5173" -ForegroundColor Gray
Write-Host ""
Write-Host "3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞµÑ€Ğ²ĞµÑ€:" -ForegroundColor White
Write-Host "   npm run dev" -ForegroundColor Gray
Write-Host ""
Write-Host "âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ­Ñ‚Ğ¾ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚!" -ForegroundColor Yellow
Write-Host "   Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸." -ForegroundColor Yellow
Write-Host "   Ğ”Ğ»Ñ production Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Let's Encrypt." -ForegroundColor Yellow
Write-Host ""
