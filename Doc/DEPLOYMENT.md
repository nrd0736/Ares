# Руководство по развёртыванию с помощью скрипта manage.ps1

Скрипт **manage.ps1** — интерактивное меню для первичной настройки, запуска приложения и управления данными на Windows. Расположение: **APEC/scripts/manage.ps1**. Запускать рекомендуется из папки **scripts** или из корня проекта **APEC**.

---


## Запуск скрипта

Запустите Start.bat или

1. Откройте PowerShell с правами администратора.
2. Перейдите в каталог скриптов:
   - `cd C:\путь\к\APEC\scripts`
   - либо в корень проекта: `cd C:\путь\к\APEC` и затем укажите путь к скрипту при вызове.
3. Выполните:
   - `.\manage.ps1`
   - Если политика выполнения запрещает скрипты: `Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned`, затем снова `.\manage.ps1`.

После запуска отображается меню с нумерованными пунктами. Ввод номера запускает соответствующее действие.

---

## Пункты меню

### 1. Initialization (Node.js, PostgreSQL, DB, npm)

**Назначение:** проверка окружения и первичная подготовка к работе.

**Выполняемые шаги:**

1. **Node.js** — проверка наличия `node` в PATH. Если не найден — попытка найти в стандартных путях и добавить в PATH пользователя; при отсутствии — предложение установки через winget (OpenJS.NodeJS.LTS). После установки через winget нужно перезапустить PowerShell и снова запустить скрипт.
2. **PostgreSQL** — проверка наличия `psql` в PATH. Если не найден — поиск по реестру и типичным путям установки (Program Files), добавление каталога `bin` в PATH при необходимости. Если PostgreSQL не найден — предложение установки через winget (PostgreSQL 16); установка может занять несколько минут. После установки может потребоваться перезапуск PowerShell.
3. **Служба PostgreSQL** — проверка, что одна из служб с именем, содержащим «postgresql», запущена. Если служба найдена, но остановлена — попытка её запуска. Если служба не найдена, выполняется проверка подключения к серверу (например, `psql -U postgres -c "SELECT 1"`). При ошибке подключения шаг считается неудачным.
4. **База данных** — проверка существования базы `apec_db`. Если базы нет — создание командой `CREATE DATABASE apec_db` от имени пользователя `postgres` (пароль берётся из переменной PGPASSWORD, по умолчанию «postgres»). При ошибке создания выводится подсказка выполнить команду вручную.
5. **Зависимости npm** — проверка наличия установленных зависимостей в корне проекта (наличие нужных исполняемых файлов и пакетов в node_modules). При отсутствии выполняется `npm install --legacy-peer-deps` в корне APEC с переменными, отключающими загрузку Chromium для Puppeteer и пост-установочную генерацию Prisma. После установки при необходимости выполняется генерация Prisma-клиента в каталоге backend.

**Результат:** в консоли отображается результат каждого шага (OK / FAIL / WARN). В конце даются рекомендации: при успехе — перейти к пункту 5 (конфигурация) и пункту 2 (запуск); при ошибках — устранить их и снова выполнить пункт 1.

---

### 2. Start Application

**Назначение:** запуск backend и frontend и открытие браузера.

**Выполняемые шаги:**

1. Проверка наличия зависимостей в корне проекта. При отсутствии — запуск `npm install --legacy-peer-deps` в корне (с теми же переменными окружения, что и в пункте 1).
2. Проверка сгенерированного Prisma-клиента. При отсутствии — выполнение `npx prisma generate` в каталоге backend.
3. Запуск backend в отдельном окне PowerShell: переход в `backend` и выполнение `npm run dev` (обычно порт 3000).
4. Запуск frontend в другом отдельном окне: переход в `frontend` и выполнение `npm run dev` (обычно порт 5173).
5. Ожидание 5 секунд и открытие в браузере адреса фронтенда (например, http://localhost:5173).

**Результат:** в консоли выводятся адреса фронтенда и backend; приложение доступно по указанному фронтенд-адресу. Окна с backend и frontend нужно оставить открытыми; закрытие окон останавливает серверы.

---

### 3. Load Test Data

**Назначение:** загрузка тестовых данных в базу (пользователи, команды, соревнования и т.п.) для разработки и демонстрации.

**Выполняемые шаги:** перед выполнением запрашивается подтверждение (y/n). При подтверждении из каталога **scripts** запускается скрипт **seed-test-data.js** (через `node seed-test-data.js`). Скрипт подключается к базе по строке из backend/.env и создаёт тестовые записи.

**Важно:** данные добавляются к существующим; при многократном запуске возможны дубликаты или конфликты. Используйте для тестовой среды или после очистки базы (пункт 7).

---

### 4. Load Reference Data

**Назначение:** загрузка справочных данных (регионы, федеральные округа, виды спорта, весовые категории, разряды и т.д.), необходимых для работы приложения.

**Выполняемые шаги:** из каталога **scripts** запускается **seed-references.js**. Справочники заполняются или обновляются согласно логике скрипта. Ошибки подключения к БД отображаются в консоли.

**Рекомендация:** выполнять после первого применения миграций (в том числе после пункта 5) и после полной очистки базы (пункт 7).

---

### 5. Configuration (.env + migrations)

**Назначение:** пошаговая настройка переменных окружения и инициализация базы (миграции и справочники).

**Выполняемые шаги:**

1. **Чтение существующих .env** — если в проекте уже есть `backend/.env` и `frontend/.env`, их значения подставляются как значения по умолчанию в запросах ниже.
2. **Сервер (1/7)** — запрос PORT, HOST, NODE_ENV. По умолчанию — 3000, 0.0.0.0, development/production.
3. **База данных (2/7)** — разбор существующего DATABASE_URL (если есть) и запрос: хост, порт, имя БД, пользователь, пароль (ввод пароля скрыт). Формируется строка DATABASE_URL в формате PostgreSQL.
4. **JWT и аутентификация (3/7)** — JWT_SECRET (с возможностью оставить текущий, сгенерировать новый или ввести вручную), JWT_EXPIRES_IN, включение валидации JWT, минимальная длина секрета, обязательность секрета в production.
5. **CORS (4/7)** — включение CORS, разрешённый origin (URL фронтенда), разрешение учётных данных.
6. **HTTPS/SSL (5/7)** — включение HTTPS и при необходимости пути к сертификату, ключу, CA и паролю ключа.
7. **Безопасность и rate limiting (6/7)** — предлагается либо принять значения по умолчанию, либо перейти в «подробный» режим. В подробном режиме запрашиваются: общий лимит запросов, лимит на вход, лимит на загрузки, правила паролей, санитизация логов и HTML, валидация файлов (в т.ч. magic bytes и MIME).
8. **Загрузки и фронтенд (7/7)** — каталог загрузок, максимальный размер файла, URL API и Socket для фронтенда (VITE_API_URL, VITE_SOCKET_URL).
9. **Сохранение .env** — запись сформированного содержимого в **backend/.env** и **frontend/.env** в кодировке UTF-8 без BOM.
10. **Миграции** — выполнение в каталоге backend команды `npm run prisma:migrate` (обычно `prisma migrate dev`). Используется пароль БД из введённого ранее DATABASE_URL. При ошибке миграции выводится сообщение и процесс останавливается.
11. **Справочники** — запуск **seed-references.js** из scripts для загрузки справочных данных.

**Результат:** готовые файлы .env и применённая схема БД с базовыми справочниками. Далее рекомендуется создать учётную запись администратора (пункт 6) и запустить приложение (пункт 2).

---

### 6. Create Admin User

**Назначение:** создание новой учётной записи с ролью администратора.

**Выполняемые шаги:** запрос ввода email, пароля (с скрытым вводом), имени и фамилии. Обязательны email и пароль; при отсутствии имени/фамилии подставляются значения по умолчанию. Из каталога **scripts** вызывается **create-test-users.js** с переданными аргументами. Скрипт подключается к БД по backend/.env, создаёт пользователя с ролью ADMIN и профилем, пароль хешируется. В консоль выводятся введённые учётные данные.

**Важно:** для первого входа в систему после развёртывания необходимо хотя бы одного администратора создать этим пунктом или вручную через скрипт/БД.

---

### 7. Clear Database & Uploads

**Назначение:** полная очистка данных БД и загруженных файлов с восстановлением схемы и справочников.

**Выполняемые шаги:**

1. Дважды запрашивается подтверждение вводом слова **YES**. При несовпадении действие отменяется.
2. **Сброс БД** — в каталоге backend выполняется `npx prisma migrate reset --force`. Все данные удаляются, схема пересоздаётся по миграциям.
3. **Очистка загрузок** — удаление файлов в каталогах **backend/uploads** и **backend/temp** (с сохранением структуры каталогов при необходимости).
4. **Справочники** — повторный запуск **seed-references.js** для восстановления справочных данных.

**Результат:** пустая база с актуальной схемой и справочниками; загрузки удалены. Учётные записи (в том числе администраторов) нужно создавать заново (пункт 6). Используйте этот пункт только когда уверены, что данные можно удалить.

---

### 0. Exit

Выход из скрипта.

---

## Рекомендуемый порядок первого развёртывания

1. Скопировать проект.
2. Запустить Start.bat или открыть PowerShell, перейти в **APEC/scripts**, запустить **manage.ps1**.
3. Выбрать **1 (Initialization)** — проверить Node.js и PostgreSQL, создать базу, установить зависимости. Исправить ошибки при их появлении.
4. Выбрать **5 (Configuration)** — заполнить .env, применить миграции, загрузить справочники.
5. Выбрать **6 (Create Admin User)** — создать первого администратора.
6. Выбрать **2 (Start Application)** — запустить backend и frontend, войти в систему под созданным администратором.

При необходимости тестовых данных после шагов 1–4 можно выполнить пункт **3 (Load Test Data)** перед или после создания администратора. Пункт **4 (Load Reference Data)** можно повторно выполнять после очистки (пункт 7) или если справочники были изменены вручную и нужно перезалить их из скрипта.

Важно, перед загрузкой тестовых данных загрузите данные справочников!
---

